"use strict";function error(a){return logger(a.message)}function readMetadata(a,b,c){var d,e=b+a.collectionName;if(fs.existsSync(e)===!1)return error(new Error("missing metadata for "+a.collectionName)),c();try{d=JSON.parse(fs.readFileSync(e,{encoding:"utf8"}))}catch(f){return error(f),c()}if(0===d.length)return c();for(var g=0,h=0,i=d.length;i>g;g++){var j=d[g];if(/^_id/.test(j.name)!==!0){var k=j.name.substr(0,j.name.length-2);a.createIndex(k,j,function(a){null!==a&&error(a),++h===i&&c()})}else++h===i&&c()}}function makeDir(a,b){fs.stat(a,function(c,d){null!==c&&"ENOENT"===c.code?(logger("make dir at "+a),fs.mkdir(a,b(null,a))):void 0!==d&&d.isDirectory()===!1?(logger("make dir at "+a),fs.unlink(a,function(){fs.mkdir(a,b(error(new Error("path was a file")),a))})):b(null,a)})}function rmDir(a,b){fs.readdirSync(a).forEach(function(c){var d=a+c;if(fs.statSync(d).isDirectory()!==!1){var e="",f=fs.readdirSync(d);fs.existsSync(d+"/.metadata")===!0&&(e=d+"/.metadata/",delete f[f.indexOf(".metadata")]),f.forEach(function(a){var c=d+"/"+a;fs.statSync(c).isDirectory()!==!1&&(fs.readdirSync(c).forEach(function(a){var d=c+"/"+a;void 0!==b&&b(null,d),fs.unlinkSync(d)}),""!==e&&fs.unlinkSync(e+a),fs.rmdirSync(c))}),""!==e&&fs.rmdirSync(e),fs.rmdirSync(d)}})}function fromJson(a,b,c){var d=fs.readdirSync(b),e=d.length,f=0;return 1>e?c(null):void d.forEach(function(d){var g,h=b+d;if(fs.statSync(h).isFile()===!1||/.json$/.test(h)===!1){var i=new Error("document is not a valid format");return e===++f?c(i):error(i)}try{g=JSON.parse(fs.readFileSync(h,{encoding:"utf8"}))}catch(i){return e===++f?c(i):error(i)}a.save(g,function(a){return null!==a?e===++f?c(a):error(a):e===++f?c(null):null})})}function fromBson(a,b,c){var d=fs.readdirSync(b),e=d.length,f=0;return 1>e?c(null):void d.forEach(function(d){var g,h=b+d;if(fs.statSync(h).isFile()===!1||/.bson$/.test(h)===!1){var i=new Error("document is not a valid format");return e===++f?c(i):error(i)}try{g=BSON.deserialize(fs.readFileSync(h,{encoding:null}))}catch(i){return e===++f?c(i):error(i)}a.save(g,function(a){return null!==a?e===++f?c(a):error(a):e===++f?c(null):null})})}function allCollections(a,b,c,d,e){var f=fs.readdirSync(b),g=f.length,h=0;return 1>g?e(null):(f.indexOf(".metadata")>=0&&(delete f[f.indexOf(".metadata")],g--),void f.forEach(function(f){var i=b+f;if(!fs.statSync(i).isDirectory()){var j=new Error(i+" is not a directory");return g===++h?e(j):error(j)}a.createCollection(f,function(a,b){return null!==a?g===++h?e(a):error(a):(logger("select collection "+f),void meta(b,c,function(){d(b,i+"/",function(a){return null!==a?g===++h?e(a):error(a):g===++h?e(null):null})}))})}))}function wrapper(a){function b(){logger("restore stop"),null!==a.tar&&rmDir(a.dir),null!==a.callback&&(logger("callback run"),a.callback())}var c;switch(a.parser){case"bson":BSON=require("bson").BSONPure.BSON,c=fromBson;break;case"json":c=fromJson;break;default:throw new Error("missing parser option")}var d=allCollections;null===a.logger?logger=function(){}:(logger=require("logger-request")({filename:a.logger,standalone:!0,winston:{logger:"_mongo_r",level:"info"}}))("restore start");var e="";meta=a.metadata===!0?readMetadata:function(a,b,c){return c()};var f=function(f){a.metadata===!0&&(e=f+".metadata/"),client.connect(a.uri,function(a,g){return logger("db open"),null!==a?error(a):void d(g,f,e,c,function(a){a&&error(a),logger("db close"),g.close(),b()})})};null===a.tar?f(a.root):(logger("open tar file at "+a.root+a.tar),makeDir(a.dir,function(){rmDir(a.dir);var b=require("tar").Extract({path:a.dir}).on("error",error).on("end",function(){for(var b=fs.readdirSync(a.dir),c=0,d=b.length;d>c;c++){var e=a.dir+b[c];if(fs.statSync(e).isFile()===!1)return f(e+"/")}});fs.createReadStream(a.root+a.tar).on("error",error).pipe(b)}))}function restore(a){var b=a||Object.create(null);if(!b.uri)throw new Error("missing uri option");if(!b.root)throw new Error("missing root option");if(!fs.existsSync(b.root)||!fs.statSync(b.root).isDirectory())throw new Error("root option is not a directory");var c={dir:__dirname+"/dump/",uri:String(b.uri),root:resolve(String(b.root))+"/",parser:String(b.parser||"bson"),callback:"function"==typeof b.callback?b.callback:null,tar:"string"==typeof b.tar?b.tar:null,logger:"string"==typeof b.logger?resolve(b.logger):null,metadata:Boolean(b.metadata)};return wrapper(c)}try{var fs=require("fs"),resolve=require("path").resolve,client=require("mongodb").MongoClient,BSON,logger,meta}catch(MODULE_NOT_FOUND){console.error(MODULE_NOT_FOUND),process.exit(1)}module.exports=restore;
